<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Single studies using the CaseCrossover package • CaseCrossover</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Single studies using the CaseCrossover package">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CaseCrossover</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MultipleAnalyses.html">Running multiple analyses at once using the CaseCrossover package</a>
    </li>
    <li>
      <a href="../articles/SingleStudies.html">Single studies using the CaseCrossover package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/OHDSI/CaseCrossover">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Single studies using the CaseCrossover package</h1>
                        <h4 class="author">Martijn J. Schuemie</h4>
            
            <h4 class="date">2018-11-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/CaseCrossover/blob/master/vignettes/SingleStudies.Rmd"><code>vignettes/SingleStudies.Rmd</code></a></small>
      <div class="hidden name"><code>SingleStudies.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette describes how you can use the <code>CaseCrossover</code> package to perform a single case-crossover study. We will walk through all the steps needed to perform an exemplar study, and we have selected the well-studied topic of the effect of NSAIDs on gastrointestinal (GI) bleeding-related hospitalization. For simplicity, we focus on one NSAID: diclofenac.</p>
</div>
<div id="installation-instructions" class="section level1">
<h1 class="hasAnchor">
<a href="#installation-instructions" class="anchor"></a>Installation instructions</h1>
<p>Before installing the <code>CaseCrossover</code> package make sure you have Java available. Java can be downloaded from <a href="http://www.java.com">www.java.com</a>. For Windows users, RTools is also necessary. RTools can be downloaded from <a href="http://cran.r-project.org/bin/windows/Rtools/">CRAN</a>.</p>
<p>The <code>CaseCrossover</code> package is currently maintained in a <a href="https://github.com/OHDSI/CaseCrossover">Github repository</a>, and has dependencies on other packages in Github. All of these packages can be downloaded and installed from within R using the <code>drat</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="st">"drat"</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">drat<span class="op">::</span><span class="kw">addRepo</span>(<span class="st">"OHDSI"</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">install.packages</span>(<span class="st">"CaseCrossover"</span>)</a></code></pre></div>
<p>Once installed, you can type <code>library(CaseCrossover)</code> to load the package.</p>
</div>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>In the <code>CaseCrossover</code> package a study requires four steps:</p>
<ol style="list-style-type: decimal">
<li>Loading data on the cases (and potential controls when performing a case-time-control analysis) from the database needed for matching.</li>
<li>Selecting subjects to include in the study.</li>
<li>Determining exposure status for cases (and controls) based on a definition of the risk windows.</li>
<li>Fitting the model using conditional logistic regression.</li>
</ol>
<p>In the following sections these steps will be demonstrated.</p>
</div>
<div id="configuring-the-connection-to-the-server" class="section level1">
<h1 class="hasAnchor">
<a href="#configuring-the-connection-to-the-server" class="anchor"></a>Configuring the connection to the server</h1>
<p>We need to tell R how to connect to the server where the data are. <code>CaseCrossover</code> uses the <code>DatabaseConnector</code> package, which provides the <code>createConnectionDetails</code> function. Type <code>?createConnectionDetails</code> for the specific settings required for the various database management systems (DBMS). For example, one might connect to a PostgreSQL database using this code:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">connectionDetails &lt;-<span class="st"> </span><span class="kw">createConnectionDetails</span>(<span class="dt">dbms =</span> <span class="st">"postgresql"</span>, </a>
<a class="sourceLine" id="cb2-2" data-line-number="2">                                             <span class="dt">server =</span> <span class="st">"localhost/ohdsi"</span>, </a>
<a class="sourceLine" id="cb2-3" data-line-number="3">                                             <span class="dt">user =</span> <span class="st">"joe"</span>, </a>
<a class="sourceLine" id="cb2-4" data-line-number="4">                                             <span class="dt">password =</span> <span class="st">"supersecret"</span>)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">cdmDatabaseSchema &lt;-<span class="st"> "my_cdm_data"</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">cohortDatabaseSchema &lt;-<span class="st"> "my_results"</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">cohortTable &lt;-<span class="st"> "my_cohorts"</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">cdmVersion &lt;-<span class="st"> "5"</span></a></code></pre></div>
<p>The last three lines define the <code>cdmDatabaseSchema</code> and <code>cohortDatabaseSchema</code> variables,as well as the CDM version. We’ll use these later to tell R where the data in CDM format live, where we have stored our cohorts of interest, and what version CDM is used. Note that for Microsoft SQL Server, databaseschemas need to specify both the database and the schema, so for example <code>cdmDatabaseSchema &lt;- "my_cdm_data.dbo"</code>.</p>
</div>
<div id="preparing-the-health-outcome-of-interest-and-nesting-cohort" class="section level1">
<h1 class="hasAnchor">
<a href="#preparing-the-health-outcome-of-interest-and-nesting-cohort" class="anchor"></a>Preparing the health outcome of interest and nesting cohort</h1>
<p>We need to define the exposures and outcomes for our study. Additionally, we can specify a cohort in which to nest the study. The CDM also already contains standard cohorts in the <code>drug_era</code> and <code>condition_era</code> table that could be used if those meet the requirement of the study, but often we require custom cohort definitions. One way to define cohorts is by writing SQL statements against the OMOP CDM that populate a table of events in which we are interested. The resulting table should have the same structure as the <code>cohort</code> table in the CDM, meaning it should have the fields <code>cohort_definition_id</code>, <code>cohort_start_date</code>, <code>cohort_end_date</code>,and <code>subject_id</code>.</p>
<p>For our example study, we will rely on <code>drug_era</code> to define exposures, and we have created a file called <em>vignette.sql</em> with the following contents to define the outcome and the nesting cohort:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">/***********************************</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">File vignette.sql </span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">***********************************/</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">IF</span> OBJECT_ID(<span class="st">'@cohortDatabaseSchema.@cohortTable'</span>, <span class="st">'U'</span>) <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">  <span class="kw">DROP</span> <span class="kw">TABLE</span> @cohortDatabaseSchema.@cohortTable;</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="kw">SELECT</span> <span class="dv">1</span> <span class="kw">AS</span> cohort_definition_id,</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    condition_start_date <span class="kw">AS</span> cohort_start_date,</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">    condition_end_date <span class="kw">AS</span> cohort_end_date,</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">    condition_occurrence.person_id <span class="kw">AS</span> subject_id</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw">INTO</span> @cohortDatabaseSchema.@cohortTable</a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="kw">FROM</span> @cdmDatabaseSchema.condition_occurrence</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="kw">INNER</span> <span class="kw">JOIN</span> @cdmDatabaseSchema.visit_occurrence</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">    <span class="kw">ON</span> condition_occurrence.visit_occurrence_id = visit_occurrence.visit_occurrence_id</a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="kw">WHERE</span> condition_concept_id <span class="kw">IN</span> (</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">        <span class="kw">SELECT</span> descendant_concept_id</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">        <span class="kw">FROM</span> @cdmDatabaseSchema.concept_ancestor</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">        <span class="kw">WHERE</span> ancestor_concept_id = <span class="dv">192671</span> <span class="co">-- GI - Gastrointestinal haemorrhage</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">        )</a>
<a class="sourceLine" id="cb3-21" data-line-number="21">    <span class="kw">AND</span> visit_occurrence.visit_concept_id <span class="kw">IN</span> (<span class="dv">9201</span>, <span class="dv">9203</span>);</a>
<a class="sourceLine" id="cb3-22" data-line-number="22">    </a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="kw">INSERT</span> <span class="kw">INTO</span> @cohortDatabaseSchema.@cohortTable </a>
<a class="sourceLine" id="cb3-24" data-line-number="24">(cohort_definition_id, cohort_start_date, cohort_end_date, subject_id)</a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="kw">SELECT</span> <span class="dv">2</span> <span class="kw">AS</span> cohort_definition_id,</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">    <span class="fu">MIN</span>(condition_start_date) <span class="kw">AS</span> cohort_start_date,</a>
<a class="sourceLine" id="cb3-27" data-line-number="27">    <span class="kw">NULL</span> <span class="kw">AS</span> cohort_end_date,</a>
<a class="sourceLine" id="cb3-28" data-line-number="28">    person_id <span class="kw">AS</span> subject_id</a>
<a class="sourceLine" id="cb3-29" data-line-number="29"><span class="kw">FROM</span> @cdmDatabaseSchema.condition_occurrence</a>
<a class="sourceLine" id="cb3-30" data-line-number="30"><span class="kw">WHERE</span> condition_concept_id <span class="kw">IN</span> (</a>
<a class="sourceLine" id="cb3-31" data-line-number="31">        <span class="kw">SELECT</span> descendant_concept_id</a>
<a class="sourceLine" id="cb3-32" data-line-number="32">        <span class="kw">FROM</span> @cdmDatabaseSchema.concept_ancestor</a>
<a class="sourceLine" id="cb3-33" data-line-number="33">        <span class="kw">WHERE</span> ancestor_concept_id = <span class="dv">80809</span> <span class="co">-- rheumatoid arthritis</span></a>
<a class="sourceLine" id="cb3-34" data-line-number="34">        )</a>
<a class="sourceLine" id="cb3-35" data-line-number="35"><span class="kw">GROUP</span> <span class="kw">BY</span> person_id;</a></code></pre></div>
<p>This is parameterized SQL which can be used by the <code>SqlRender</code> package. We use parameterized SQL so we do not have to pre-specify the names of the CDM and cohort schemas. That way, if we want to run the SQL on a different schema, we only need to change the parameter values; we do not have to change the SQL code. By also making use of translation functionality in <code>SqlRender</code>, we can make sure the SQL code can be run in many different environments.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">library</span>(SqlRender)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">sql &lt;-<span class="st"> </span><span class="kw">readSql</span>(<span class="st">"vignette.sql"</span>)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">sql &lt;-<span class="st"> </span><span class="kw">renderSql</span>(sql,</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">                 <span class="dt">cdmDatabaseSchema =</span> cdmDatabaseSchema, </a>
<a class="sourceLine" id="cb4-5" data-line-number="5">                 <span class="dt">cohortDatabaseSchema =</span> cohortDatabaseSchema</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">                 <span class="dt">cohortTable =</span> cohortTable)<span class="op">$</span>sql</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">sql &lt;-<span class="st"> </span><span class="kw">translateSql</span>(sql, <span class="dt">targetDialect =</span> connectionDetails<span class="op">$</span>dbms)<span class="op">$</span>sql</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">connection &lt;-<span class="st"> </span><span class="kw">connect</span>(connectionDetails)</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="kw">executeSql</span>(connection, sql)</a></code></pre></div>
<p>In this code, we first read the SQL from the file into memory. In the next line, we replace the three parameter names with the actual values. We then translate the SQL into the dialect appropriate for the DBMS we already specified in the <code>connectionDetails</code>. Next, we connect to the server, and submit the rendered and translated SQL.</p>
<p>If all went well, we now have a table with the outcome of interest and the nesting cohort. We can see how many events:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">sql &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">"SELECT cohort_definition_id, COUNT(*) AS count"</span>,</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">             <span class="st">"FROM @cohortDatabaseSchema.@cohortTable"</span>,</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">             <span class="st">"GROUP BY cohort_definition_id"</span>)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">sql &lt;-<span class="st"> </span><span class="kw">renderSql</span>(sql, </a>
<a class="sourceLine" id="cb5-5" data-line-number="5">                 <span class="dt">cohortDatabaseSchema =</span> cohortDatabaseSchema, </a>
<a class="sourceLine" id="cb5-6" data-line-number="6">                 <span class="dt">cohortTable =</span> cohortTable)<span class="op">$</span>sql</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">sql &lt;-<span class="st"> </span><span class="kw">translateSql</span>(sql, <span class="dt">targetDialect =</span> connectionDetails<span class="op">$</span>dbms)<span class="op">$</span>sql</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="kw">querySql</span>(connection, sql)</a></code></pre></div>
<pre><code>#&gt;   cohort_definition_id  count
#&gt; 1                    1 422274
#&gt; 2                    2 118430</code></pre>
</div>
<div id="extracting-the-data-from-the-server" class="section level1">
<h1 class="hasAnchor">
<a href="#extracting-the-data-from-the-server" class="anchor"></a>Extracting the data from the server</h1>
<p>Now we can tell <code>CaseCrossover</code> to extract the necessary data on the cases:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">caseCrossoverData &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getDbCaseCrossoverData.html">getDbCaseCrossoverData</a></span>(<span class="dt">connectionDetails =</span> connectionDetails,</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">                                            <span class="dt">cdmDatabaseSchema =</span> cdmDatabaseSchema,</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">                                            <span class="dt">oracleTempSchema =</span> oracleTempSchema,</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">                                            <span class="dt">outcomeDatabaseSchema =</span> cohortDatabaseSchema,</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">                                            <span class="dt">outcomeTable =</span> cohortTable,</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">                                            <span class="dt">outcomeId =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">                                            <span class="dt">exposureDatabaseSchema =</span> cdmDatabaseSchema,</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">                                            <span class="dt">exposureTable =</span> <span class="st">"drug_era"</span>,</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">                                            <span class="dt">exposureIds =</span> <span class="dv">1124300</span>,</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">                                            <span class="dt">useNestingCohort =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">                                            <span class="dt">nestingCohortDatabaseSchema =</span> cohortDatabaseSchema,</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">                                            <span class="dt">nestingCohortTable =</span> cohortTable,</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">                                            <span class="dt">nestingCohortId =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">                                            <span class="dt">useObservationEndAsNestingEndDate =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">                                            <span class="dt">getTimeControlData =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb7-16" data-line-number="16"></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"></a>
<a class="sourceLine" id="cb7-18" data-line-number="18">caseCrossoverData</a></code></pre></div>
<pre><code>#&gt; Case-crossover data object
#&gt; 
#&gt; Outcome concept ID(s): 1
#&gt; Nesting cohort ID: 2
#&gt; Exposure concept ID(s): 1124300</code></pre>
<p>There are many parameters, but they are all documented in the <code>CaseCrossover</code> manual. In short, we are pointing the function to the table created earlier and indicating which concept ID in that table identifies the outcome. Note that it is possible to fetch the data for multiple outcomes at once for efficiency. We specify that we will use the <code>drug_era</code> table to identify exposures, and will only retrieve data on exposure to Diclofenac (concept ID 1124300). We furthermore specify a nesting cohort in the same table, meaning that people will be eligible to be cases if and when they fall inside the specified cohort. In this case, the nesting cohort starts when people have their first diagnosis of rheumatoid arthritis. We use the <code>useObservationEndAsNestingEndDate</code> argument to indicate people will stay eligible until the end of their observation period. We furthermore specify we want to retrieve data on time controls, which will be used later to adjust for time-trends in exposures, effectively turning the case-crossover study into a case-time-control study.</p>
<p>Data about the cases (and potential time controls) are extracted from the server and stored in the <code>caseCrossoverData</code> object. This object uses the package <code>ff</code> to store information in a way that ensures R does not run out of memory, even when the data are large.</p>
<p>We can use the generic <code>summary()</code> function to view some more information of the data we extracted:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">summary</span>(caseCrossoverData)</a></code></pre></div>
<pre><code>#&gt; Case-crossover data object summary
#&gt; 
#&gt; Outcome concept ID(s): 1
#&gt; Nesting cohort ID: 2
#&gt; 
#&gt; Population count: 168765
#&gt; Population window count: 168765
#&gt; 
#&gt; Outcome counts:
#&gt;   Event count Case count
#&gt; 1       20309      12821
#&gt; 
#&gt; Exposure counts:
#&gt;         Exposure count Person count
#&gt; 1124300          43721        21977</code></pre>
<div id="saving-the-data-to-file" class="section level2">
<h2 class="hasAnchor">
<a href="#saving-the-data-to-file" class="anchor"></a>Saving the data to file</h2>
<p>Creating the <code>caseCrossoverData</code> object can take considerable computing time, and it is probably a good idea to save it for future sessions. Because <code>caseCrossoverData</code> uses <code>ff</code>, we cannot use R’s regular save function. Instead, we’ll have to use the <code><a href="../reference/saveCaseCrossoverData.html">saveCaseCrossoverData()</a></code> function:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="../reference/saveCaseCrossoverData.html">saveCaseCrossoverData</a></span>(caseCrossoverData, <span class="st">"GiBleed"</span>)</a></code></pre></div>
<p>We can use the <code><a href="../reference/loadCaseCrossoverData.html">loadCaseCrossoverData()</a></code> function to load the data in a future session.</p>
</div>
</div>
<div id="selecting-subjects" class="section level1">
<h1 class="hasAnchor">
<a href="#selecting-subjects" class="anchor"></a>Selecting subjects</h1>
<p>Next, we can use the data to select matched controls per case:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">subjects &lt;-<span class="st"> </span><span class="kw"><a href="../reference/selectSubjectsToInclude.html">selectSubjectsToInclude</a></span>(<span class="dt">caseCrossoverData =</span> caseCrossoverData,</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">                                    <span class="dt">outcomeId =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">                                    <span class="dt">firstOutcomeOnly =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">                                    <span class="dt">washoutPeriod =</span> <span class="dv">183</span>)</a></code></pre></div>
<p>In this example, we specify a washout period of 180 days, meaning that cases (and controls) are required to have a minimum of 180 days of observation prior to the index date. We also specify we will only consider the first outcome per person. If a person’s first outcome is within the washout period, that person will be removed from the analysis.</p>
<p>The <code>subjects</code> object is a data frame with five columns:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">head</span>(subjects)</a></code></pre></div>
<pre><code>#&gt;   personId  indexDate isCase stratumId observationPeriodStartDate
#&gt; 1        3 2009-10-10   TRUE         1                 2001-10-12
#&gt; 2      123 2009-10-11   TRUE         2                 2002-01-11
#&gt; 3      345 2009-10-09   TRUE         3                 2001-05-03
#&gt; 4        6 2010-05-04   TRUE         4                 2003-02-01
#&gt; 5      234 2010-05-04   TRUE         5                 2007-01-01
#&gt; 6      567 2010-05-05   TRUE         6                 2006-03-01</code></pre>
<p>We can show the attrition to see why cases and events were filtered:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw"><a href="../reference/getAttritionTable.html">getAttritionTable</a></span>(subjects)</a></code></pre></div>
<pre><code>#&gt;                      description eventCount caseCount
#&gt; 1                Original counts      20309     12821
#&gt; 2               First event only      12821     12821
#&gt; 3 Require 183 days of prior obs.       7555      7555</code></pre>
</div>
<div id="determining-exposure-status" class="section level1">
<h1 class="hasAnchor">
<a href="#determining-exposure-status" class="anchor"></a>Determining exposure status</h1>
<p>We can now evaluate the exposure status of the cases in various time windows relative to the index date:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">exposureStatus &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getExposureStatus.html">getExposureStatus</a></span>(<span class="dt">subjects =</span> subjects,</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">                                    <span class="dt">caseCrossoverData =</span> caseCrossoverData,</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">                                    <span class="dt">exposureId =</span> <span class="dv">1124300</span>,</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">                                    <span class="dt">firstExposureOnly =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">                                    <span class="dt">riskWindowStart =</span> <span class="dv">-30</span>,</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">                                    <span class="dt">riskWindowEnd =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">                                    <span class="dt">controlWindowOffsets =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">60</span>))</a></code></pre></div>
<p>Here we specify we are intested in all exposures, not just the first one, and that we will use two windows per subject: a case window defined as the 30 days preceding (and including) the index date, and a control window which has the same length as the case window but is shifted 60 days backwards, so from 90 days to (and including) 60 days prior to the index date. Note that multiple control windows can be specified by specifying more control window offsets.</p>
<p>Exposure status is then determined based on whether an exposure overlaps with one of the windows. The resulting <code>exposureStatus</code> object is a data frame with six columns:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">head</span>(exposureStatus)</a></code></pre></div>
<pre><code>#&gt;   personId  indexDate isCase stratumId isCaseWindow exposed
#&gt; 1        3 2009-10-10   TRUE         1         TRUE       0
#&gt; 2      123 2009-10-11   TRUE         2         TRUE       0
#&gt; 3      345 2009-10-09   TRUE         3         TRUE       0
#&gt; 4        6 2010-05-04   TRUE         4         TRUE       0
#&gt; 5      234 2010-05-04   TRUE         5         TRUE       0
#&gt; 6      567 2010-05-05   TRUE         6         TRUE       0</code></pre>
</div>
<div id="fitting-the-model" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-the-model" class="anchor"></a>Fitting the model</h1>
<p>We can now fit the model, which is a logistic regression conditioned on the matched sets:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitCaseCrossoverModel.html">fitCaseCrossoverModel</a></span>(exposureStatus)</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"></a>
<a class="sourceLine" id="cb20-3" data-line-number="3">fit</a></code></pre></div>
<pre><code>#&gt; Case-Crossover fitted model
#&gt; Status: OK
#&gt; 
#&gt;           Estimate lower .95 upper .95    logRr seLogRr
#&gt; treatment 1.068966  0.747257  1.529176 0.066691  0.1827</code></pre>
<p>The generic functions <code>summary</code>, <code>coef</code>, and <code>confint</code> are implemented for the <code>fit</code> object:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">summary</span>(fit)</a></code></pre></div>
<pre><code>#&gt; Case-Crossover fitted model
#&gt; Status: OK
#&gt; 
#&gt;           Estimate lower .95 upper .95    logRr seLogRr
#&gt; treatment 1.068966  0.747257  1.529176 0.066691  0.1827
#&gt; 
#&gt; Counts
#&gt;       Cases Controls Control win. (cases) Control win. (controls)
#&gt; Count  7555        0                 7555                       0
#&gt;       Exposed case win. (cases) Exposed control win. (cases)
#&gt; Count                       160                          156
#&gt;       Exposed case win. (controls) Exposed control win. (controls)
#&gt; Count                            0                               0</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw">coef</span>(fit)</a></code></pre></div>
<pre><code>#&gt; [1] 0.06669137</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw">confint</span>(fit)</a></code></pre></div>
<pre><code>#&gt; [1] -0.2913464  0.4247292</code></pre>
</div>
<div id="case-time-control" class="section level1">
<h1 class="hasAnchor">
<a href="#case-time-control" class="anchor"></a>Case-time-control</h1>
<p>A variant of the case-crossover design is the case-time-control design. This design adjusts for time-trends in exposure by using a set of control subjects. To use this design in the <code>CaseCrossover</code> package, one needs to simply provide matching criteria to the <code>selectSubjectsToInclude</code> function:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">matchingCriteria &lt;-<span class="st"> </span><span class="kw"><a href="../reference/createMatchingCriteria.html">createMatchingCriteria</a></span>(<span class="dt">controlsPerCase =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">                                           <span class="dt">matchOnAge =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">                                           <span class="dt">ageCaliper =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb28-4" data-line-number="4">                                           <span class="dt">matchOnGender =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb28-5" data-line-number="5"></a>
<a class="sourceLine" id="cb28-6" data-line-number="6">subjectsCtc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/selectSubjectsToInclude.html">selectSubjectsToInclude</a></span>(<span class="dt">caseCrossoverData =</span> caseCrossoverData,</a>
<a class="sourceLine" id="cb28-7" data-line-number="7">                                       <span class="dt">outcomeId =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb28-8" data-line-number="8">                                       <span class="dt">firstOutcomeOnly =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb28-9" data-line-number="9">                                       <span class="dt">washoutPeriod =</span> <span class="dv">183</span>,</a>
<a class="sourceLine" id="cb28-10" data-line-number="10">                                       <span class="dt">matchingCriteria =</span> matchingCriteria)</a></code></pre></div>
<p>The other steps remain the same:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">exposureStatusCtc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getExposureStatus.html">getExposureStatus</a></span>(<span class="dt">subjects =</span> subjectsCtc,</a>
<a class="sourceLine" id="cb29-2" data-line-number="2">                                       <span class="dt">caseCrossoverData =</span> caseCrossoverData,</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">                                       <span class="dt">exposureId =</span> <span class="dv">1124300</span>,</a>
<a class="sourceLine" id="cb29-4" data-line-number="4">                                       <span class="dt">firstExposureOnly =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb29-5" data-line-number="5">                                       <span class="dt">riskWindowStart =</span> <span class="dv">-30</span>,</a>
<a class="sourceLine" id="cb29-6" data-line-number="6">                                       <span class="dt">riskWindowEnd =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb29-7" data-line-number="7">                                       <span class="dt">controlWindowOffsets =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">60</span>))</a>
<a class="sourceLine" id="cb29-8" data-line-number="8"></a>
<a class="sourceLine" id="cb29-9" data-line-number="9">fitCtc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitCaseCrossoverModel.html">fitCaseCrossoverModel</a></span>(exposureStatusCtc)</a>
<a class="sourceLine" id="cb29-10" data-line-number="10"></a>
<a class="sourceLine" id="cb29-11" data-line-number="11"><span class="kw">summary</span>(fitCtc)</a></code></pre></div>
<pre><code>#&gt; Case-Crossover fitted model
#&gt; Status: OK
#&gt; 
#&gt;           Estimate lower .95 upper .95   logRr seLogRr
#&gt; treatment  1.31394   0.77897   2.21630 0.27303  0.2667
#&gt; 
#&gt; Counts
#&gt;       Cases Controls Control win. (cases) Control win. (controls)
#&gt; Count  7555     7555                 7555                    7555
#&gt;       Exposed case win. (cases) Exposed control win. (cases)
#&gt; Count                       160                          156
#&gt;       Exposed case win. (controls) Exposed control win. (controls)
#&gt; Count                          136                             147</code></pre>
</div>
<div id="acknowledgments" class="section level1">
<h1 class="hasAnchor">
<a href="#acknowledgments" class="anchor"></a>Acknowledgments</h1>
<p>Considerable work has been dedicated to provide the <code>CaseCrossover</code> package.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw">citation</span>(<span class="st">"CaseCrossover"</span>)</a></code></pre></div>
<pre><code>#&gt; 
#&gt; To cite package 'CaseCrossover' in publications use:
#&gt; 
#&gt;   Martijn Schuemie (2018). CaseCrossover: Case-Crossover. R
#&gt;   package version 1.1.0. https://github.com/OHDSI/CaseCrossover
#&gt; 
#&gt; A BibTeX entry for LaTeX users is
#&gt; 
#&gt;   @Manual{,
#&gt;     title = {CaseCrossover: Case-Crossover},
#&gt;     author = {Martijn Schuemie},
#&gt;     year = {2018},
#&gt;     note = {R package version 1.1.0},
#&gt;     url = {https://github.com/OHDSI/CaseCrossover},
#&gt;   }</code></pre>
<p>Furthermore, <code>CaseCrossover</code> makes extensive use of the <code>Cyclops</code> package.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="kw">citation</span>(<span class="st">"Cyclops"</span>)</a></code></pre></div>
<pre><code>#&gt; 
#&gt; To cite Cyclops in publications use:
#&gt; 
#&gt; Suchard MA, Simpson SE, Zorych I, Ryan P, Madigan D (2013).
#&gt; "Massive parallelization of serial inference algorithms for
#&gt; complex generalized linear models." _ACM Transactions on Modeling
#&gt; and Computer Simulation_, *23*, 10. &lt;URL:
#&gt; http://dl.acm.org/citation.cfm?id=2414791&gt;.
#&gt; 
#&gt; A BibTeX entry for LaTeX users is
#&gt; 
#&gt;   @Article{,
#&gt;     author = {M. A. Suchard and S. E. Simpson and I. Zorych and P. Ryan and D. Madigan},
#&gt;     title = {Massive parallelization of serial inference algorithms for complex generalized linear models},
#&gt;     journal = {ACM Transactions on Modeling and Computer Simulation},
#&gt;     volume = {23},
#&gt;     pages = {10},
#&gt;     year = {2013},
#&gt;     url = {http://dl.acm.org/citation.cfm?id=2414791},
#&gt;   }</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#installation-instructions">Installation instructions</a></li>
      <li><a href="#overview">Overview</a></li>
      <li><a href="#configuring-the-connection-to-the-server">Configuring the connection to the server</a></li>
      <li><a href="#preparing-the-health-outcome-of-interest-and-nesting-cohort">Preparing the health outcome of interest and nesting cohort</a></li>
      <li>
<a href="#extracting-the-data-from-the-server">Extracting the data from the server</a><ul class="nav nav-pills nav-stacked">
<li><a href="#saving-the-data-to-file">Saving the data to file</a></li>
      </ul>
</li>
      <li><a href="#selecting-subjects">Selecting subjects</a></li>
      <li><a href="#determining-exposure-status">Determining exposure status</a></li>
      <li><a href="#fitting-the-model">Fitting the model</a></li>
      <li><a href="#case-time-control">Case-time-control</a></li>
      <li><a href="#acknowledgments">Acknowledgments</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Martijn Schuemie.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
